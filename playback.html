<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音楽プレーヤー</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f7f2;
            margin: 0;
            display: flex;
            height: 100vh;
        }

        #mainContainer {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #playerContainer {
            flex: 2;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-right: 1px solid #ddd;
        }

        #playlistContainer {
            flex: 1;
            padding: 20px;
            background-color: #f4f4f4;
            overflow-y: auto;
        }

        #playlistContainer h2 {
            margin-top: 0;
            font-size: 18px;
            color: #333;
        }

        #playlist {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #playlist li {
            padding: 10px;
            margin: 5px 0;
            background-color: #fff;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #playlist li:hover {
            background-color: #e6f7ff;
        }

        #playlist li.playing {
            background-color: #80e0ff; /* 再生中の項目のハイライト */
            font-weight: bold;
        }

        .remove-btn {
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .remove-btn:hover {
            background-color: #ff1a1a;
        }

        #fileNameDisplay {
            font-size: 18px;
            margin-bottom: 10px;
        }

        canvas {
            width: 100%;
            height: 150px;
            background: #f0f0f0;
            margin: 20px 0;
            border-radius: 12px;
            border: 1px solid #ddd;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #7cb9e8;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }

        button:disabled {
            background-color: #d3d3d3;
            cursor: not-allowed;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        #fileList {
            list-style-type: none;
            padding: 0;
            margin-top: 20px;
        }

        #fileList li {
            padding: 8px;
            margin: 5px 0;
            background-color: #fff;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease;
        }

        #fileList li:hover {
            background-color: #f0f8ff;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>
    <div id="mainContainer">
        <div id="playerContainer">
            <p id="fileNameDisplay">再生中: 未選択</p>
            <canvas id="analyzerCanvas"></canvas>
            <div>
                <input type="range" id="progressBar" min="0" max="100" value="0" />
                <div id="timeDisplay" style="display: flex; justify-content: space-between; font-size: 14px;">
                    <span id="currentTime">00:00</span>
                    <span id="duration">00:00</span>
                </div>
            </div>
            <div>
                <button id="playBtn">再生</button>
                <button id="pauseBtn" disabled>一時停止</button>
                <button id="stopBtn">停止</button>
            </div>
            <div style="margin-top: 10px;">
                <label for="volumeBar">音量:</label>
                <input type="range" id="volumeBar" min="0" max="1" step="0.01" value="0.5" />
            </div>
        </div>

        <div id="playlistContainer">
            <h2>再生リスト</h2>
            <ul id="playlist">
                <!-- 再生リストがここに追加されます -->
            </ul>

            <h3>ファイルリスト</h3>
            <ul id="fileList">
                <!-- ここにファイルリストを追加 -->
            </ul>
        </div>
    </div>

    <script>
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const volumeBar = document.getElementById('volumeBar');
        const progressBar = document.getElementById('progressBar');
        const currentTimeDisplay = document.getElementById('currentTime');
        const durationDisplay = document.getElementById('duration');
        const analyzerCanvas = document.getElementById('analyzerCanvas');
        const canvasCtx = analyzerCanvas.getContext('2d');
        const playlist = document.getElementById('playlist');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const fileList = document.getElementById('fileList');

        let audio = new Audio();
        let audioContext, analyser, dataArray, bufferLength;
        let playlistArray = []; // 再生リストに追加する曲を管理する配列
        let isPlaying = false; // 再生中かどうか

        // localStorageから音楽ファイル情報を取得
        const savedFiles = JSON.parse(localStorage.getItem('musicFiles')) || [];

        // 音楽ファイルリストを表示
        savedFiles.forEach((file, index) => {
            const li = document.createElement('li');
            li.textContent = `ファイル ${index + 1}: ${file.name}`;
            li.dataset.src = file.url;
            fileList.appendChild(li);
        });

        // 音楽ファイルを再生リストに追加する
        fileList.addEventListener('click', (event) => {
            if (event.target.tagName === 'LI') {
                const src = event.target.getAttribute('data-src');
                const name = event.target.textContent;

                // 再生リストに8曲以上のファイルがないかチェック
                if (playlistArray.length < 8) {
                    // 曲を追加（重複を気にせず追加）
                    playlistArray.push({ name, url: src });
                    updatePlaylist();
                } else {
                    alert('再生リストに追加できるのは8曲までです。');
                }
            }
        });

        // 再生リストの更新
        function updatePlaylist() {
            playlist.innerHTML = ''; // 現在の再生リストをクリア
            playlistArray.forEach((file, index) => {
                const li = document.createElement('li');
                li.textContent = `${file.name}`;
                li.dataset.src = file.url;

                // 再生中の曲は"playing"クラスを付けて視覚的に区別
                if (index === 0 && isPlaying) {
                    li.classList.add('playing');
                }

                // 削除ボタンを追加
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '×';
                removeBtn.classList.add('remove-btn');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // リスト項目クリックイベントを止める
                    removeFromPlaylist(file.url);
                });

                li.appendChild(removeBtn);
                playlist.appendChild(li);
            });
        }

        // 再生リストから曲を削除
        function removeFromPlaylist(url) {
            playlistArray = playlistArray.filter(file => file.url !== url);
            updatePlaylist();
        }

        // 音楽再生を管理する関数
        function setupAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaElementSource(audio);

            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            source.connect(analyser);
            analyser.connect(audioContext.destination);

            // 音楽の再生時間が変わるたびに進捗を更新
            audio.ontimeupdate = () => {
                updateProgress();
                updateTimeDisplay();
            };

            // 音楽の再生が終了したら次の曲に進む
            audio.onended = () => {
                nextSong();
            };
        }

        // 音楽再生の進捗を更新する
        function updateProgress() {
            if (audio.duration) {
                const progress = (audio.currentTime / audio.duration) * 100;
                progressBar.value = progress;
            }
        }

        // 再生時間の表示を更新する
        function updateTimeDisplay() {
            const currentMinutes = Math.floor(audio.currentTime / 60);
            const currentSeconds = Math.floor(audio.currentTime % 60);
            currentTimeDisplay.textContent = `${pad(currentMinutes)}:${pad(currentSeconds)}`;

            const durationMinutes = Math.floor(audio.duration / 60);
            const durationSeconds = Math.floor(audio.duration % 60);
            durationDisplay.textContent = `${pad(durationMinutes)}:${pad(durationSeconds)}`;
        }

        // 時間の表示を2桁に揃える
        function pad(number) {
            return number < 10 ? '0' + number : number;
        }

        // 音楽の再生・一時停止
        playBtn.addEventListener('click', () => {
            if (!audio.src) {
                const firstSong = playlistArray[0];
                audio.src = firstSong.url;
                fileNameDisplay.textContent = `再生中: ${firstSong.name}`;
                setupAudio();
                audio.play();
                isPlaying = true;
                playBtn.disabled = true;
                pauseBtn.disabled = false;
            } else {
                audio.play();
                isPlaying = true;
                playBtn.disabled = true;
                pauseBtn.disabled = false;
            }
        });

        pauseBtn.addEventListener('click', () => {
            audio.pause();
            isPlaying = false;
            playBtn.disabled = false;
            pauseBtn.disabled = true;
        });

        stopBtn.addEventListener('click', () => {
            audio.pause();
            audio.currentTime = 0;
            isPlaying = false;
            playBtn.disabled = false;
            pauseBtn.disabled = true;
        });

        // 音量の変更
        volumeBar.addEventListener('input', (event) => {
            audio.volume = event.target.value;
        });

        // 音楽再生リスト内の曲をクリックして再生
        playlist.addEventListener('click', (event) => {
            if (event.target.tagName === 'LI') {
                const songUrl = event.target.dataset.src;
                audio.src = songUrl;
                audio.play();
                isPlaying = true;
                fileNameDisplay.textContent = `再生中: ${event.target.textContent}`;
                updatePlaylist();
            }
        });

        // 次の曲へ
        function nextSong() {
            const currentIndex = playlistArray.findIndex(file => file.url === audio.src);
            if (currentIndex < playlistArray.length - 1) {
                audio.src = playlistArray[currentIndex + 1].url;
                fileNameDisplay.textContent = `再生中: ${playlistArray[currentIndex + 1].name}`;
                audio.play();
                updatePlaylist();
            }
        }

        // アナライザビジュアライゼーション
        function renderVisualizer() {
            requestAnimationFrame(renderVisualizer);
            analyser.getByteFrequencyData(dataArray);

            canvasCtx.fillStyle = '#f0f0f0';
            canvasCtx.fillRect(0, 0, analyzerCanvas.width, analyzerCanvas.height);

            const barWidth = (analyzerCanvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i];

                canvasCtx.fillStyle = 'rgb(' + (barHeight + 100) + ',50,50)';
                canvasCtx.fillRect(x, analyzerCanvas.height - barHeight / 2, barWidth, barHeight / 2);
                x += barWidth + 1;
            }
        }

        // 音楽ビジュアライゼーションを開始
        renderVisualizer();

        // 初期設定
        window.onload = () => {
            updatePlaylist();
        };

    </script>
</body>
</html>
